# Code Generation

lazypaw generates fully-typed client code from your SQL Server schema — Row, Insert, and Update types per table with smart handling of IDENTITY, DEFAULT, computed, and nullable columns.

## Usage

```bash
# TypeScript
lazypaw codegen --lang typescript --output ./src/db-types.ts

# Python
lazypaw codegen --lang python --output ./db_types.py
```

lazypaw connects to your database (using the same connection args), introspects `sys.columns`, and generates the output file.

```bash
# Full example with connection args
lazypaw --server localhost --database mydb --user sa --password pass \
  codegen --lang typescript --output ./src/db-types.ts
```

## Supported Languages

### TypeScript

Generates a `Database` interface with `Row`, `Insert`, and `Update` types per table:

```typescript
// AUTO-GENERATED by lazypaw codegen
// Database: mydb | Generated: 2025-01-15T10:30:00Z
// Do not edit manually — re-run: lazypaw codegen --lang typescript

export interface Database {
  users: {
    Row: {
      id: number
      name: string
      email: string | null
      created_at: string
      is_active: boolean
    }
    Insert: {
      // id: auto-generated (IDENTITY)
      name: string
      email?: string // nullable
      created_at?: string // has DEFAULT
      is_active?: boolean // has DEFAULT
    }
    Update: {
      name?: string
      email?: string
      created_at?: string
      is_active?: boolean
    }
  }
  orders: {
    Row: {
      id: number
      user_id: number
      total: number
      status: string
    }
    Insert: {
      // id: auto-generated (IDENTITY)
      user_id: number
      total: number
      status?: string // has DEFAULT
    }
    Update: {
      user_id?: number
      total?: number
      status?: string
    }
  }
}
```

### Python

Generates Pydantic models with `Row`, `Insert`, and `Update` classes per table:

```python
# AUTO-GENERATED by lazypaw codegen
# Database: mydb | Generated: 2025-01-15T10:30:00Z

from __future__ import annotations
from pydantic import BaseModel
from datetime import datetime, date, time
from typing import Any, Optional

class UsersRow(BaseModel):
    id: int
    name: str
    email: Optional[str] = None
    created_at: datetime
    is_active: bool

class UsersInsert(BaseModel):
    name: str
    email: Optional[str] = None
    created_at: Optional[datetime] = None
    is_active: Optional[bool] = None

class UsersUpdate(BaseModel):
    name: Optional[str] = None
    email: Optional[str] = None
    created_at: Optional[datetime] = None
    is_active: Optional[bool] = None
```

## Type Mappings

### SQL Server → TypeScript

| SQL Server Type | TypeScript Type |
|-----------------|-----------------|
| `int`, `smallint`, `tinyint`, `bigint` | `number` |
| `float`, `real`, `decimal`, `numeric` | `number` |
| `money`, `smallmoney` | `number` |
| `bit` | `boolean` |
| `varchar`, `nvarchar`, `char`, `nchar` | `string` |
| `text`, `ntext` | `string` |
| `datetime`, `datetime2`, `date`, `time` | `string` |
| `smalldatetime`, `datetimeoffset` | `string` |
| `uniqueidentifier` | `string` |
| `varbinary`, `binary`, `image` | `string` |
| `xml` | `string` |

### SQL Server → Python

| SQL Server Type | Python Type |
|-----------------|-------------|
| `int`, `smallint`, `tinyint`, `bigint` | `int` |
| `float`, `real`, `decimal`, `numeric` | `float` |
| `money`, `smallmoney` | `float` |
| `bit` | `bool` |
| `varchar`, `nvarchar`, `char`, `nchar` | `str` |
| `text`, `ntext` | `str` |
| `uniqueidentifier` | `str` |
| `datetime`, `datetime2`, `datetimeoffset` | `datetime` |
| `date` | `date` |
| `time` | `time` |
| `varbinary`, `binary`, `image` | `bytes` |

## Smart Fields

Codegen understands your schema constraints and generates appropriate types:

| Column Property | Row Type | Insert Type | Update Type |
|-----------------|----------|-------------|-------------|
| **IDENTITY** | Included | Excluded (comment) | Excluded |
| **DEFAULT** | Required | Optional (`?`) | Optional (`?`) |
| **Computed** | Included | Excluded (comment) | Excluded |
| **Nullable** | `T \| null` | Optional (`?`) | Optional (`?`) |
| **Required** | `T` | Required | Optional (`?`) |

This means:
- You can't accidentally set an IDENTITY column on insert
- Columns with defaults are optional on insert (the DB fills them in)
- Computed columns are read-only
- Update types make everything optional (you only send what you want to change)

## Using with SDK

```typescript
import type { Database } from './db-types'
import { createClient } from 'lazypaw-js'

const lp = createClient<Database>('http://localhost:3000')

// Full type safety on reads
const { data } = await lp.from('users').select('*')
//    ^? Database['users']['Row'][] | null

// Type-checked inserts — IDENTITY and computed columns rejected at compile time
await lp.from('users').insert({
  name: 'Alice',          // required
  email: 'alice@co.com',  // optional (nullable)
  // id — not allowed (IDENTITY)
  // created_at — optional (has DEFAULT)
})

// Type-checked updates — all fields optional
await lp.from('users').update({ name: 'Bob' }).eq('id', 1)
```

## CI Integration

Re-generate types in CI to keep them in sync with your database:

### GitHub Actions

```yaml
# .github/workflows/codegen.yml
name: Update DB Types
on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6am

jobs:
  codegen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install lazypaw
        run: |
          curl -L https://github.com/copycatdb/lazypaw/releases/latest/download/lazypaw-linux-x64 -o lazypaw
          chmod +x lazypaw

      - name: Generate types
        run: |
          ./lazypaw --server ${{ secrets.DB_SERVER }} \
                    --database ${{ secrets.DB_NAME }} \
                    --user ${{ secrets.DB_USER }} \
                    --password ${{ secrets.DB_PASSWORD }} \
                    codegen --lang typescript --output ./src/db-types.ts

      - name: Commit if changed
        run: |
          git diff --quiet || {
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add src/db-types.ts
            git commit -m "chore: update generated DB types"
            git push
          }
```

### Pre-commit hook

```bash
#!/bin/sh
# .git/hooks/pre-commit
lazypaw --server localhost --database mydb --user sa --password pass \
  codegen --lang typescript --output ./src/db-types.ts
git add ./src/db-types.ts
```

### npm script

```json
{
  "scripts": {
    "db:types": "lazypaw codegen --lang typescript --output ./src/db-types.ts",
    "db:types:python": "lazypaw codegen --lang python --output ./db_types.py"
  }
}
```

```bash
npm run db:types
```
